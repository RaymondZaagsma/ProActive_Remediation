#################################
#Configure encoded commands here#
#################################

$encodedcommand1 = "JABrAGIAIAA9ACAAIgBLAEIANQAwADAANAA5ADQANQAiAAoAJABrAGIAcwBlAGEAcgBjAGgAIAA9ACAAIgAqACQAawBiACoAIgAKACQAdABpAHQAbABlADEAIAA9ACAAIgBXAEkATgBEAE8AVwBTACAASQBTACAAQwBVAFIAUgBFAE4AVABMAFkAIABCAEUASQBOAEcAIABVAFAARABBAFQARQBEACIACgAkAG0AZQBzAHMAYQBnAGUAMQAgAD0AIAAiAEEAIABpAG0AcABvAHIAdABhAG4AdAAgAFcAaQBuAGQAbwB3AHMAIAB1AHAAZABhAHQAZQAgACQAawBiACAAaQBzACAAYgBlAGkAbgBnACAAaQBuAHMAdABhAGwAbABlAGQALAAgAHAAbABlAGEAcwBlACAAZABvAG4AJwB0ACAAcgBlAGIAbwBvAHQAIAB5AG8AdQByACAAZABlAHYAaQBjAGUAIQAiAAoAJAB0AGkAdABsAGUAMgAgAD0AIAAiAFcASQBOAEQATwBXAFMAIABJAFMAIABVAFAARABBAFQARQBEACIACgAkAG0AZQBzAHMAYQBnAGUAMgAgAD0AIAAiAFcAaQBuAGQAbwB3AHMAIAB1AHAAZABhAHQAZQAgACQAawBiACAAdwBhAHMAIABpAG4AcwB0AGEAbABsAGUAZAAgAHMAdQBjAGMAZQBzAGYAdQBsAGwAeQAsACAAcABsAGUAYQBzAGUAIAByAGUAYgBvAG8AdAAgAHkAbwB1AHIAIABkAGUAdgBpAGMAZQAhACIACgAkAHQAaQB0AGwAZQAzAD0AIAAiAFcASQBOAEQATwBXAFMAIABVAFAARABBAFQARQAgAEYAQQBJAEwARQBEACIACgAkAG0AZQBzAHMAYQBnAGUAMwAgAD0AIAAiAFcAaQBuAGQAbwB3AHMAIAB1AHAAZABhAHQAZQAgACQAawBiACAAZgBhAGkAbABlAGQAIAB0AG8AIABpAG4AcwB0AGEAbABsACEAIABwAGwAZQBhAHMAZQAgAHIAZQBiAG8AbwB0ACAAeQBvAHUAcgAgAGQAZQB2AGkAYwBlACEAIgAKAFsAcgBlAGYAbABlAGMAdABpAG8AbgAuAGEAcwBzAGUAbQBiAGwAeQBdADoAOgBsAG8AYQBkAHcAaQB0AGgAcABhAHIAdABpAGEAbABuAGEAbQBlACgAIgBTAHkAcwB0AGUAbQAuAFcAaQBuAGQAbwB3AHMALgBGAG8AcgBtAHMAIgApAAoAWwByAGUAZgBsAGUAYwB0AGkAbwBuAC4AYQBzAHMAZQBtAGIAbAB5AF0AOgA6AGwAbwBhAGQAdwBpAHQAaABwAGEAcgB0AGkAYQBsAG4AYQBtAGUAKAAiAFMAeQBzAHQAZQBtAC4ARAByAGEAdwBpAG4AZwAiACkACgAkAHAAYQB0AGgAIAA9ACAARwBlAHQALQBQAHIAbwBjAGUAcwBzACAALQBpAGQAIAAkAHAAaQBkACAAfAAgAFMAZQBsAGUAYwB0AC0ATwBiAGoAZQBjAHQAIAAtAEUAeABwAGEAbgBkAFAAcgBvAHAAZQByAHQAeQAgAFAAYQB0AGgAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAKACQAaQBjAG8AbgAgAD0AIABbAFMAeQBzAHQAZQBtAC4ARAByAGEAdwBpAG4AZwAuAEkAYwBvAG4AXQA6ADoARQB4AHQAcgBhAGMAdABBAHMAcwBvAGMAaQBhAHQAZQBkAEkAYwBvAG4AKAAkAHAAYQB0AGgAKQAgACAAIAAgACAAIAAgACAAIAAgACAACgAkAG4AbwB0AGkAZgB5ACAAPQAgAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABzAHkAcwB0AGUAbQAuAHcAaQBuAGQAbwB3AHMALgBmAG8AcgBtAHMALgBuAG8AdABpAGYAeQBpAGMAbwBuAAoAJABuAG8AdABpAGYAeQAuAGkAYwBvAG4AIAA9ACAAJABpAGMAbwBuAAoAJABuAG8AdABpAGYAeQAuAHYAaQBzAGkAYgBsAGUAIAA9ACAAJAB0AHIAdQBlAAoAJABuAG8AdABpAGYAeQAuAHMAaABvAHcAYgBhAGwAbABvAG8AbgB0AGkAcAAoADUAMAAsACQAdABpAHQAbABlADEALAAkAE0AZQBzAHMAYQBnAGUAMQAsAFsAcwB5AHMAdABlAG0ALgB3AGkAbgBkAG8AdwBzAC4AZgBvAHIAbQBzAC4AdABvAG8AbAB0AGkAcABpAGMAbwBuAF0AOgA6AGkAbgBmAG8AKQAgAAoAaQBuAHMAdABhAGwAbAAtAHcAaQBuAGQAbwB3AHMAdQBwAGQAYQB0AGUAIAAtAGsAYgBhAHIAdABpAGMAbABlAGkAZAAgACQAawBiACAALQBhAGMAYwBlAHAAdABhAGwAbAAgAC0ASQBuAHMAdABhAGwAbAAgAC0AaQBnAG4AbwByAGUAcgBlAGIAbwBvAHQACgBpAGYAIAAoACQAcwB0AGEAdAB1AHMAIAA9ACAARwBlAHQALQBoAG8AdABmAGkAeAAgAHwAIAB3AGgAZQByAGUALQBvAGIAagBlAGMAdAAgAHsAKAAkAF8ALgBIAG8AdABGAGkAeABJAEQAIAAtAGwAaQBrAGUAIAAkAGsAYgBzAGUAYQByAGMAaAAgACkAfQApAAoACQB7AAoACQAJACQAbgBvAHQAaQBmAHkALgBzAGgAbwB3AGIAYQBsAGwAbwBvAG4AdABpAHAAKAA1ADAALAAkAHQAaQB0AGwAZQAyACwAJABNAGUAcwBzAGEAZwBlADIALABbAHMAeQBzAHQAZQBtAC4AdwBpAG4AZABvAHcAcwAuAGYAbwByAG0AcwAuAHQAbwBvAGwAdABpAHAAaQBjAG8AbgBdADoAOgBpAG4AZgBvACkAIAAKAAkACQBFAHgAaQB0ACAAMAAKAAkAfQAKAEUAbABzAGUACgAJAHsACgAgACAAIAAgAAkACQAkAG4AbwB0AGkAZgB5AC4AcwBoAG8AdwBiAGEAbABsAG8AbwBuAHQAaQBwACgANQAwACwAJAB0AGkAdABsAGUAMwAsACQATQBlAHMAcwBhAGcAZQAzACwAWwBzAHkAcwB0AGUAbQAuAHcAaQBuAGQAbwB3AHMALgBmAG8AcgBtAHMALgB0AG8AbwBsAHQAaQBwAGkAYwBvAG4AXQA6ADoAaQBuAGYAbwApACAACgAgACAAIAAgAAkACQBFAHgAaQB0ACAAMQAKAAkAfQA="

#########################################################################################
#Toast Example: please convert it to base64 and adjust the $encodedcommand above	#
#read more on https://call4cloud.nl/2021/05/the-laps-reloaded/	    			#
#											#
#      Encoded Command  | Notifying and Installing The Update				#
###########################################################################################
#$kb = "KB5004945"
#$kbsearch = "*$kb*"
#$title1 = "WINDOWS IS CURRENTLY BEING UPDATED"
#$message1 = "A important Windows update $kb is being installed, please don't reboot your device!"
#$title2 = "WINDOWS IS UPDATED"
#$message2 = "Windows update $kb was installed succesfully, please reboot your device!"
#$title3= "WINDOWS UPDATE FAILED"
#$message3 = "Windows update $kb failed to install! please reboot your device!"
#[reflection.assembly]::loadwithpartialname("System.Windows.Forms")
#[reflection.assembly]::loadwithpartialname("System.Drawing")
#$path = Get-Process -id $pid | Select-Object -ExpandProperty Path                   
#$icon = [System.Drawing.Icon]::ExtractAssociatedIcon($path)           
#$notify = new-object system.windows.forms.notifyicon
#$notify.icon = $icon
#$notify.visible = $true
#$notify.showballoontip(50,$title1,$Message1,[system.windows.forms.tooltipicon]::info) 
#install-windowsupdate -kbarticleid $kb -acceptall -Install -ignorereboot
#if ($status = Get-hotfix | where-object {($_.HotFixID -like $kbsearch )})
#	{
#		$notify.showballoontip(50,$title2,$Message2,[system.windows.forms.tooltipicon]::info) 
#		Exit 0
#	}
#Else
#	{
#   		$notify.showballoontip(50,$title3,$Message3,[system.windows.forms.tooltipicon]::info) 
#    		Exit 1
#	}
##############################################################################################

###############
#temp folder # 
##############

$path = "C:\temp\"
If(!(test-path $path))
	{
    		New-Item -ItemType Directory -Force -Path $path
	}

#######################################################################
##Detect if the pswindowsupdate is installed.. so not install it!     #
#######################################################################

if (Get-Module -ListAvailable -Name pswindowsupdate) 
	{
    		Write-Host "PSUpdate Module exists"
	} 
else 	{
		Install-PackageProvider NuGet -Force | out-null 
        	install-module pswindowsupdate -force | out-null 
   		Write-Host "Module does not exist, installing it now"
   
}

#################################################################################
#Toast notification prereq from system to user					#
#################################################################################

$path = "C:\program files (x86)\service"
New-Item -ItemType Directory -Force -Path $path
Invoke-WebRequest "https://call4cloud.nl/wp-content/uploads/2021/07/ServiceUI.zip" -OutFile "$path\ZippedFile.zip"
Expand-Archive -LiteralPath "$path\ZippedFile.zip" -DestinationPath "$path" -force


####################################################
####Install the Update task !		     #
###################################################

Try {

$triggers = New-ScheduledTaskTrigger -Once -At (get-date).AddSeconds(10); $triggers.EndBoundary = (get-date).AddSeconds(60).ToString('s')
$Action = New-ScheduledTaskAction -Execute "c:\program files (x86)\service\ServiceUI.exe" -argument "-process:explorer.exe c:\Windows\System32\WindowsPowershell\v1.0\powershell.exe -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -encodedcommand $encodedcommand1"
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -DeleteExpiredTaskAfter 00:10:00
$Null = Register-ScheduledTask -TaskName "UpdateWindows" -Trigger $triggers -User "SYSTEM" -Action $Action Settings $Settings -Force


if ($status = Get-hotfix | where-object {($_.HotFixID -like $kbsearch )})
	{
		Write-Output "Windows Update $KB has already been installed"
		Exit 0
	}
Else
	{
    		Write-Output "Windows Update failed to install $kb"
    		Exit 1
	}
	}
catch
	{
    		$errMsg = $_.Exception.Message
    		Write-Error $errMsg
   		exit 1
	}





